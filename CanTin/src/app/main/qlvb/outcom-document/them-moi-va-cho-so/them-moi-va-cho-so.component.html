<div [class]="getClassName()" [@routerTransition]>
    <div class="kt-content  kt-grid__item kt-grid__item--fluid kt-grid kt-grid--hor">
        <div class="kt-subheader kt-grid__item">
            <div [class]="containerClass">
                <div class="kt-subheader__main">
                    <h3 class="kt-subheader__title">
                        <!-- <span>{{l("Thêm mới văn bản đến")}}</span> -->
                        <span>{{header}}</span>
                    </h3>
                </div>
                <div class="kt-subheader__toolbar">
                    <div class="kt-subheader__wrapper">
                        <!-- <button class="btn btn-outline-success"><i class="fa fa-file-excel"></i> {{l("ExportToExcel")}}</button> -->
                        <!-- <dx-button text="Scan document" type="success" icon="upload" (onClick)="scanDocument()" ></dx-button> -->

                    </div>
                </div>
            </div>
        </div>
        <div [class]="containerClass + ' kt-grid__item kt-grid__item--fluid'">
            <div class="kt-portlet kt-portlet--mobile">
                <div class="modal-body">
                    <!-- <div style="max-height: 80vh; overflow: auto;" class="form-control">
                        <span *ngFor="let item of (labelDto | async)">{{item.name}} - {{item.countNum}}</span>
                    </div> -->
                    <div class="col-xl-12" style="padding-bottom: 17px;padding-left:0;">

                        <dx-button [disabled]="saving" text="Lưu" type="success" icon="save"
                            [visible]="!this.appSession.isCATP" (onClick)="buttonSaveClick()"> </dx-button>
                        &nbsp;
                        <dx-button [disabled]="saving" text="Lưu và phát hành" type="success" icon="save"
                            (onClick)="buttonSaveAndPublishClick()"> </dx-button>
                        &nbsp;
                        <dx-button text="Trở về" type="success" icon="fa fa-arrow-left" (onClick)="back()"></dx-button>
                    </div>
                    <dx-form id="form" #documentForm [formData]="documentData" [showValidationSummary]="true"
                        (onContentReady)="onContentReady($event)" [showColonAfterLabel]="false"
                        validationGroup="formValidateGroup">
                        <dxi-item itemType="group" colCount="12" caption="Thông tin văn bản">
                            <!-- <dxi-item [colSpan]="4" dataField="book" editorType="dxSelectBox" [editorOptions]="bookOptions">
                                <dxo-label text="Sổ VB"></dxo-label>
                                <dxi-validation-rule type="required"></dxi-validation-rule>
                            </dxi-item> -->
                            <!-- <dxi-item [colSpan]="4" dataField="book" editorType="dxSelectBox" [editorOptions]="bookOptions"> -->
                            <dxi-item [colSpan]="4" id="bookName" dataField="book" editorType="dxSelectBox"
                                [editorOptions]="{
                                valueExpr: 'id',
                                displayExpr: 'name',
                                searchEnabled: true,
                                searchExpr: 'name',
                                dataSource: dataBook,
                                onValueChanged: onComBookValueChanged
                            }">
                                <dxo-label text="Sổ VB"></dxo-label>
                                <dxi-validation-rule type="required" message="Chưa chọn sổ VB"></dxi-validation-rule>
                                <dxi-validation-rule type="custom" message="Sổ VB không khớp với độ mật"
                                    [reevaluate]="true" [validationCallback]="checkBookType"></dxi-validation-rule>
                            </dxi-item>
                            <dxi-item itemType="group" [colSpan]="4" colCount="16">
                                <dxi-item [colSpan]="14" dataField="number"
                                    [editorOptions]="{ disabled: isDraftNumberDisabled }">
                                    <dxo-label text="Số VB đi"></dxo-label>
                                    <!-- <dx-text-box dataField="number" [(value)]="soKyHieu" [(disabled)]="isNumberDisabled"></dx-text-box> -->
                                </dxi-item>
                                <dxi-item [colSpan]="1">
                                    <dx-button icon="info" alignment="right"
                                        [elementAttr]="{id:'btnShowMissingNum', class: 'btnShowMissingNum'}"
                                        hint="{{missingNumber}}" (onClick)="showMissingNumberPopup()"></dx-button>
                                </dxi-item>
                                <dxi-item [colSpan]="1" editorType="dxCheckBox" alignment="right"
                                    [cssClass]="'autoChkBxClass'" [editorOptions]="{
                                        value: numberChBkValue,
                                        onValueChanged: numberChanged
                                    }">
                                </dxi-item>
                            </dxi-item>
                            <!-- <dxi-item [colSpan]="4" itemType="group" colCount="12">

                            </dxi-item> -->

                            <dxi-item [colSpan]="4" dataField="releaseDate" editorType="dxDateBox"
                                [editorOptions]="releaseDateOptions">
                                <dxo-label text="Ngày VB"></dxo-label>
                                <dxi-validation-rule type="required" message="Chưa chọn ngày VB"></dxi-validation-rule>
                            </dxi-item>
                            <!-- <dxi-item itemType="group" [colSpan]="4" colCount="16">
                                <dxi-item [colSpan]="15" editorType="dxTextBox" dataField="draftNumber" [editorOptions]="{
                                    disabled: isDraftNumberDisabled
                                }">
                                    <dxo-label text="Mã dự thảo"></dxo-label>
                                    <dxi-validation-rule type="required"></dxi-validation-rule>
                                </dxi-item>
                                <dxi-item [colSpan]="1" editorType="dxCheckBox" alignment="right" [cssClass]="'autoChkBxClass'" [editorOptions]="draftNumBerChkBoxOptions">
                                </dxi-item>
                            </dxi-item> -->

                            <!-- <dxi-item dataField="publishDate" [colSpan]="4" editorType="dxDateBox"
                                [editorOptions]="{ displayFormat:'dd/MM/yyyy', showClearButton: true, disabled: isReadOnlyForm, value: currentDate }">
                                <dxo-label text="Ngày soạn"></dxo-label>
                                <dxi-validation-rule type="required"></dxi-validation-rule>
                            </dxi-item> -->
                            <dxi-item dataField="orgEditor" [colSpan]="4" editorType="dxSelectBox" [editorOptions]="{
                                dataSource: data_department,
                                valueExpr: 'id',
                                displayExpr: 'displayName',
                                searchEnabled: true,
                                searchExpr: ['displayName', 'shortentCode'],
                                disabled: isNotEdited
                            }">

                                <dxo-label text="Phòng ban soạn"></dxo-label>
                            </dxi-item>
                            <!-- <dxi-item dataField="editorId" [colSpan]="4" editorType="dxSelectBox" [editorOptions]="{
                                dataSource: editorList,
                                valueExpr: 'userId',
                                displayExpr: 'nameWithPosition',
                                searchEnabled: true,
                                searchExpr: ['nameWithPosition'],
                                showClearButton: true,
                                readOnly: isReadOnlyForm
                                }">
                                <dxo-label text="Người soạn" ></dxo-label>
                            </dxi-item> -->

                            <dxi-item [colSpan]="4" dataField="documentTypeId" editorType="dxSelectBox"
                                [editorOptions]="documentTypeOptions">
                                <dxo-label text="Loại VB"></dxo-label>
                            </dxi-item>


                            <dxi-item [colSpan]="4" dataField="isNoneSubmit" editorType="dxCheckBox" [editorOptions]="{

                            }">
                                <dxo-label text="Chưa nộp lưu"></dxo-label>
                            </dxi-item>
                            <!-- <dxi-item itemType="empty" [colSpan]="4"></dxi-item> -->

                            <!-- <dxi-item [colSpan]="4">
                                <dxo-label text="Lĩnh vực"></dxo-label>
                                <dx-select-box
                                    [dataSource]="data_range"
                                    valueExpr="key"
                                    displayExpr="value"
                                    [searchEnabled]="true"
                                    [searchExpr]="['value']"
                                    [showClearButton]="true"
                                    [(value)]="rangeVal"
                                ></dx-select-box>
                            </dxi-item>

                            <dxi-item [colSpan]="4">
                                <dxo-label text="Độ khẩn"></dxo-label>
                                <dx-select-box
                                    [dataSource]="data_priority"
                                    valueExpr="key"
                                    displayExpr="value"
                                    [searchEnabled]="true"
                                    [searchExpr]="['value']"
                                    [showClearButton]="true"
                                    [(value)]="priorityVal"
                                ></dx-select-box>
                            </dxi-item>
                         -->
                            <dxi-item [colSpan]="4">
                                <dxo-label text="Số lượng VBPH"></dxo-label>
                                <dx-number-box dataField="quantityDocumentPublish" [(value)]="quantityDocPublishVal">
                                </dx-number-box>
                            </dxi-item>
                            <dxi-item [colSpan]="4">
                                <dxo-label text="Số tờ"></dxo-label>
                                <dx-number-box dataField="piecesOfPaper" editorType="dxNumberBox"
                                    [(value)]="piecesOfPaperVal"></dx-number-box>
                            </dxi-item>
                            <!-- <dxi-item [colSpan]="4">
                                <dxo-label text="Độ mật"></dxo-label>                               
                                <dx-select-box [dataSource]="data_secretLevel" valueExpr="key" displayExpr="value"
                                    [searchEnabled]="true" [searchExpr]="['value']" [showClearButton]="true"
                                    [(value)]="secretVal">                                   
                                </dx-select-box>
                                <dxi-validation-rule type="required"  message="Chưa chọn độ mật"></dxi-validation-rule>
                            </dxi-item> -->

                            <dxi-item [colSpan]="4" dataField="secretLevel" editorType="dxSelectBox"
                                [editorOptions]="secretLevelOptions">
                                <dxo-label text="Độ mật"></dxo-label>
                                <dxi-validation-rule type="required" message="Chưa chọn độ mật"></dxi-validation-rule>
                                <dxi-validation-rule type="custom" message="Độ mật không khớp với sổ VB"
                                    [reevaluate]="true" [validationCallback]="checkSecretLevel"></dxi-validation-rule>
                            </dxi-item>

                            <dxi-item itemType="group" colCount="24" [colSpan]="12">
                                <dxi-item [colSpan]="11" [visible]="isHideGroup">
                                    <dx-tag-box #groupReceiverTagBox id="groupReceiverTagBox" valueExpr="Id"
                                        [(dataSource)]="groupReceiverSource" displayExpr="GroupName"
                                        [searchEnabled]="true" [searchExpr]="['GroupName']"
                                        [showSelectionControls]="true" [showClearButton]="true"
                                        (onOpened)="onOpenedTagBox($event)" [(value)]="groupReceiverVal">
                                    </dx-tag-box>
                                    <dxo-label text="Nhóm nhận"></dxo-label>
                                </dxi-item>
                                <dxi-item [colSpan]="1" [visible]="isHideGroup">
                                    <dx-button icon="plus" alignment="right" (onClick)="showGroupReceiver()"
                                        [elementAttr]="{class: 'btnAddPublisher'}"></dx-button>
                                </dxi-item>
                                <dxi-item itemType="empty" [visible]="isHideGroup" [colSpan]="12"></dxi-item>

                                <dxi-item [colSpan]="11">
                                    <dx-tag-box #orgLevelTagBox id="orgLevelTagBox" [dataSource]="orgLevelSource"
                                        valueExpr="id" displayExpr="name" [searchEnabled]="true" [searchExpr]="['name']"
                                        [(value)]="selectedOrgLevels" (onValueChanged)="orgLevelValueChanged()">
                                    </dx-tag-box>
                                    <dxo-label text="Cấp nhận"></dxo-label>
                                </dxi-item>
                                <dxi-item [colSpan]="12">
                                    <dx-tag-box #publishOrgTagBox id="publishOrgTagBox" valueExpr="id"
                                        [(dataSource)]="publishOrgSource" displayExpr="name" [searchEnabled]="true"
                                        [searchExpr]="['name']" [(value)]="displayReceiverList"
                                        [showSelectionControls]="true" [showClearButton]="true"
                                        (onOpened)="onOpenedTagBox($event)">
                                    </dx-tag-box>
                                    <dxo-label text="Nơi nhận"></dxo-label>
                                </dxi-item>
                                <dxi-item [colSpan]="1">
                                    <dx-button icon="plus" alignment="right" (onClick)="showPublisherPopup()"
                                        [elementAttr]="{class: 'btnAddPublisher'}"></dx-button>
                                </dxi-item>
                            </dxi-item>
                            <dxi-item itemType="group" [colSpan]="12" colCount="24">
                                <dxi-item dataField="" [colSpan]="23" editorType="dxTagBox" [editorOptions]="{
                                    searchEnabled: false,
                                    noDataText: '',
                                    valueExpr: 'id',
                                    displayExpr: 'number',
                                    dataSource: selectedResponseDocs,
                                    value: selectedLinkedDocuments,
                                    onValueChanged: linkedDocValueChanged
                                }">
                                    <dxo-label text="Trả lời VB"></dxo-label>
                                </dxi-item>
                                <dxi-item dataField="" [colSpan]="1">
                                    <dx-button icon="search" alignment="right" (onClick)="selectReplyDocument()"
                                        [elementAttr]="{class: 'btnAddPublisher'}"></dx-button>
                                </dxi-item>
                            </dxi-item>
                            <dxi-item dataField="summary" [colSpan]="12" editorType="dxTextArea"
                                [editorOptions]="{ autoResizeEnabled: true }">
                                <dxo-label text="Trích yếu"></dxo-label>
                            </dxi-item>
                            <dxi-item itemType="group" [colSpan]="12" colCount="12" [visible]="true">
                                <dxi-item itemType="group" [colSpan]="6" colCount="12">
                                    <dxi-item [colSpan]="12">
                                        <dxo-label text="Tập tin"></dxo-label>
                                        <!-- <dxi-validation-rule type="required"></dxi-validation-rule> -->
                                        <dx-file-uploader [multiple]="true" selectButtonText="Chọn file đính kèm"
                                            accept="*" icon="upload" [(value)]="value" uploadMode="useForm"
                                            (onValueChanged)="setFullNameFile($event)">
                                        </dx-file-uploader>
                                    </dxi-item>
                                    <dxi-item [colSpan]="6">
                                        <dxo-label text="Scan văn bản"></dxo-label>
                                        <dx-button [disabled]="saving" text="Scan" type="success" icon="search"
                                            (onClick)="scan()">
                                        </dx-button>
                                    </dxi-item>
                                    <dxi-item [colSpan]="6">
                                        <dx-radio-group [dataSource]="scanTypes" displayExpr="display" valueExpr="value"
                                            [(value)]="scanType" (onValueChanged)="onScanTypeChanged($event)">
                                        </dx-radio-group>
                                        <!-- <dx-check-box
                                            [(value)]="isDuplex"
                                            [width]="120"
                                            text="Scan 2 mặt">
                                        </dx-check-box> -->
                                    </dxi-item>
                                </dxi-item>

                                <dxi-item [colSpan]="6">
                                    <dx-data-grid id="gridContainer" [dataSource]="selectedRows"
                                        [allowColumnReordering]="true" [allowColumnResizing]="true"
                                        [columnAutoWidth]="true" [showBorders]="true">
                                        <dxo-paging [pageSize]="10"></dxo-paging>
                                        <dxo-pager [showPageSizeSelector]="true" [allowedPageSizes]="[5, 10, 20]"
                                            [showInfo]="true">
                                        </dxo-pager>
                                        <dxi-column dataField="tepDinhKem" caption="Tệp đính kèm"></dxi-column>
                                        <dxi-column caption="Xem chi tiết" cellTemplate="detailTemplate" [width]="100">
                                        </dxi-column>
                                        <dxi-item caption="Xóa" cellTemplate="deleteTemplate">
                                        </dxi-item>
                                        <div *dxTemplate="let d of 'detailTemplate'">
                                            <div class="row">
                                                <div class="col-6" style="text-align: center;" (click)="showDetail(d)">
                                                    <span><i class="fab fa-buffer"></i></span>
                                                </div>
                                                <div class="col-6" style="text-align: center;" (click)="deleteFile(d)">
                                                    <span><i class="fas fa-trash-alt"></i> </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div *dxTemplate="let d of 'deleteTemplate'">
                                            <div class="col-2" style="text-align: center;" (click)="deleteFile(d)">
                                                <span><i class="fas fa-trash-alt"></i> </span>
                                            </div>
                                        </div>
                                    </dx-data-grid>
                                </dxi-item>
                            </dxi-item>


                            <dxi-item itemType="group" cssClass="signer-catp" colCount="12" [colSpan]="12">
                                <dxi-item [colSpan]="3" [dataField]="dataFieldConpetent"
                                    [editorType]="editorTypeConpetent" [editorOptions]="editorOptionsConpetent">
                                    <!-- <dx-select-box dataField="competentOfLeader" [dataSource]="competentOfLeaderList"
                                        valueExpr="id" displayExpr="name" [(value)]="documentData.competentOfLeader"
                                        (onValueChanged)="competentSelectionChange($event)" placeholder="Không có">
                                    </dx-select-box> -->
                                    <dxo-label text="Thẩm quyền ký"></dxo-label>
                                </dxi-item>

                                <dxi-item [colSpan]="3" [label]="{text: 'Người ký'}" dataField="leaderNotCompetent"
                                    editorType="dxSelectBox" [editorOptions]="{
                                        dataSource: director_list,
                                        valueExpr: 'userId',
                                        displayExpr: 'nameWithPosition',
                                        searchEnabled: true,
                                        searchExpr: 'fullName',
                                        disabled: isCompetent,
                                        dropDownOptions: {
                                            minWidth: 400
                                        }
                                    }">
                                </dxi-item>
                                <dxi-item [colSpan]="6" dataField="leaderId"
                                    [editorOptions]="{ disabled: !isCompetent }">
                                    <!-- <dx-text-box dataField="leaderId" [disabled]="!isCompetent"></dx-text-box> -->
                                    <dxo-label text="Người ký được thẩm quyền"></dxo-label>
                                </dxi-item>
                            </dxi-item>


                            <dxi-item itemType="group" cssClass="signer-not-catp" colCount="12" [colSpan]="12">
                                <dxi-item [colSpan]="6" dataField="leaderId"
                                    [editorOptions]="{ autoResizeEnabled: true }">
                                    <!-- <dx-text-box dataField="leaderId" [disabled]="!isCompetent"></dx-text-box> -->
                                    <dxo-label location="left" text="Người ký"></dxo-label>
                                </dxi-item>

                                <dxi-item itemType="empty" [colSpan]="6"></dxi-item>
                            </dxi-item>


                            <!-- --------------------- -->
                            <dxi-item itemType="group" cssClass="signer-catp-id" colCount="12" [colSpan]="12">
                                <dxi-item [colSpan]="3" [dataField]="dataFieldConpetent"
                                    [editorType]="editorTypeConpetent" [editorOptions]="editorOptionsConpetent">
                                    <dxo-label text="Thẩm quyền ký"></dxo-label>
                                </dxi-item>

                                <dxi-item [colSpan]="3" [label]="{text: 'Người ký'}" [dataField]="dataFieldSigner"
                                    [editorType]="editorTypeSigner" [editorOptions]="{
                                        dataSource: director_list,
                                        valueExpr: 'userId',
                                        displayExpr: 'nameWithPosition',
                                        searchEnabled: true,
                                        searchExpr: 'fullName',
                                        disabled: isCompetent,
                                        dropDownOptions: {
                                            minWidth: 400
                                        }
                                    }">
                                </dxi-item>
                                <dxi-item [colSpan]="6" dataField=""
                                    [editorOptions]="{ disabled: !isCompetent, value: leaderCompetentVal }">
                                    <!-- <dx-text-box dataField="leaderId" [disabled]="!isCompetent"></dx-text-box> -->
                                    <dxo-label text="Người ký được thẩm quyền"></dxo-label>
                                </dxi-item>
                            </dxi-item>


                            <dxi-item itemType="group" cssClass="signer-not-catp-id" colCount="12" [colSpan]="12">
                                <dxi-item [colSpan]="6" dataField="leaderId"
                                    [editorOptions]="{ autoResizeEnabled: true }">
                                    <!-- <dx-text-box dataField="leaderId" [disabled]="!isCompetent"></dx-text-box> -->
                                    <dxo-label location="left" text="Người ký"></dxo-label>
                                </dxi-item>

                                <dxi-item itemType="empty" [colSpan]="6"></dxi-item>
                            </dxi-item>




                            <dxi-item dataField="note" [colSpan]="12" editorType="dxTextArea"
                                [editorOptions]="{ autoResizeEnabled: true }">
                                <dxo-label text="Ghi chú"></dxo-label>
                            </dxi-item>
                        </dxi-item>
                    </dx-form>
                    <dx-popup [width]="500" [height]="200" [showTitle]="true" title="Thêm mới nơi phát hành"
                        [dragEnabled]="false" [closeOnOutsideClick]="true" [(visible)]="publisherPopupVisible">
                        <dx-form #publisherForm [formData]="publisherData">
                            <dxi-item [label]="{text: 'Nơi nhận'}" [colSpan]="2" dataField="publisherName"
                                editorType="dxTextBox">
                            </dxi-item>
                        </dx-form>
                        <br>
                        <div class="row">
                            <div style="display: block; margin-left: auto; margin-right: auto;">
                                <dx-button icon="save" text="Lưu" type="success" (onClick)="savepublisher()">
                                </dx-button>
                            </div>
                        </div>
                    </dx-popup>

                    <dx-popup #confirmPopUp id="confirmPopUp" [width]="500" [height]="350" [dragEnabled]="false"
                        [closeOnOutsideClick]="true" [(visible)]="confirmPopUpVisible">
                        <div class="swal2-icon swal2-warning swal2-animate-warning-icon" style="display: flex;"></div>
                        <h4 style="font-size: large; margin: auto;" class="swal2-title">{{confirmPopUpText}}</h4>
                        <div class="swal2-actions">
                            <button type="button" class="swal2-confirm swal2-styled" (click)="onYesConfirmPopUp()"
                                style="display: inline-block;border-left-color: rgb(48, 133, 214);border-right-color: rgb(48, 133, 214);">Có</button>
                            <button type="button" class="swal2-cancel swal2-styled" (click)="onCancelConfirmPopUp()"
                                style="display: inline-block;">Không</button>
                        </div>
                        <!-- <br>
                    <div class="row">
                        <div style="display: block; margin-left: auto; margin-right: auto;">
                            <dx-button icon="save" text="Lưu" type="success" (onClick)="savepublisher()"></dx-button>
                        </div>
                    </div> -->

                    </dx-popup>

                    <dx-popup [width]="1000" [height]="700" [showTitle]="true" title="Danh sách số bị khuyết"
                        [dragEnabled]="false" [closeOnOutsideClick]="true" [(visible)]="missingNumberVisible">
                        <dx-data-grid id="gridContainer" [dataSource]="missingNumberSource" height="100%"
                            [allowColumnReordering]="true" [allowColumnResizing]="true" [columnAutoWidth]="true"
                            [showBorders]="true">
                            <dxo-paging [pageSize]="10"></dxo-paging>
                            <dxo-scrolling mode="virtual"></dxo-scrolling>
                            <dxo-load-panel [enabled]="true"></dxo-load-panel>
                            <dxo-pager [showPageSizeSelector]="true" [allowedPageSizes]="[5, 10, 20]" [showInfo]="true">
                            </dxo-pager>

                            <dxi-column dataField="" cellTemplate="bookValTemplate" caption="Loại sổ">
                            </dxi-column>
                            <dxi-column dataField="" cellTemplate="missingNumberTemplate" caption="Các số bị khuyết">
                            </dxi-column>
                            <div *dxTemplate="let d of 'bookValTemplate'">
                                <div class="current-value" style="font-weight: bold;">
                                    {{currentBookInMissingNumberPopup.name}}</div>
                            </div>
                            <div *dxTemplate="let d of 'missingNumberTemplate'">
                                <div class="current-value" style="font-weight: bold;">{{missingNumberSource}}</div>
                            </div>


                        </dx-data-grid>
                    </dx-popup>

                    <dx-load-panel #loadPanel shadingColor="rgba(220,220,220, 0.5)" [position]="{ my: 'center', at: 'center', of: 'window' }"
                        [(visible)]="saving" [showIndicator]="true" message="Đang xử lý..." [showPane]="true" [shading]="true"
                        [closeOnOutsideClick]="false">
                    </dx-load-panel>
                </div>
            </div>
        </div>
    </div>
    <createReceiver #createReceiver (saveSuccess)="getPublishOrg()"></createReceiver>
    <groupReceiver #groupReceiver (saveSuccessGroup)="getGroupReceiver()" [typeGroupChild]="typeGroup"></groupReceiver>
    <searchResponseDocumentModal #searchResponseDocumentModal (modalSave)="getResponseDocuments($event)" [type]="1"
        [isCATP]="this.appSession.isCATP"></searchResponseDocumentModal>
</div>