<div [@routerTransition]>
    <div class="kt-content  kt-grid__item kt-grid__item--fluid kt-grid kt-grid--hor">
        <div class="kt-subheader kt-grid__item">
            <div [class]="containerClass">
                <div class="kt-subheader__main">
                    <h3 class="kt-subheader__title">
                        <!-- <span>{{l("Thêm mới văn bản đến")}}</span> -->
                        <span>{{"THÊM MỚI VĂN BẢN CHUYỂN CATP PHÁT HÀNH"}}</span>
                    </h3>
                </div>
                <div class="kt-subheader__toolbar">
                    <div class="kt-subheader__wrapper">
                        <!-- <button class="btn btn-outline-success"><i class="fa fa-file-excel"></i> {{l("ExportToExcel")}}</button> -->
                        <!-- <dx-button text="Scan document" type="success" icon="upload" (onClick)="scanDocument()" ></dx-button> -->

                    </div>
                </div>
            </div>
        </div>
        <div [class]="containerClass + ' kt-grid__item kt-grid__item--fluid'">
            <div class="kt-portlet kt-portlet--mobile">
                <div class="modal-body">
                    <!-- <div style="max-height: 80vh; overflow: auto;" class="form-control">
                        <span *ngFor="let item of (labelDto | async)">{{item.name}} - {{item.countNum}}</span>
                    </div> -->
                    <div class="col-xl-12" style="padding-bottom: 17px;padding-left:0;">

                        <dx-button [disabled]="saving" text="Chuyển CATP" type="success" icon="save" (onClick)="save()">
                        </dx-button>
                        &nbsp;
                        <dx-button text="Trở về" type="success" icon="fa fa-arrow-left" (onClick)="back()"></dx-button>


                    </div>
                    <dx-form #documentForm [formData]="documentData" [showValidationSummary]="true"
                        [showColonAfterLabel]="false" validationGroup="formValidateGroup">
                        <dxi-item itemType="group" colCount="6" caption="Thông tin văn bản">
                            <!-- <dxi-item itemType="group" [colSpan]="2" colCount="12">
                                <dxi-item [colSpan]="11" dataField="draftNumber" editorType="dxTextBox" [(editorOptions)]="maDuThaoOptions">
                                    <dxo-label text="Mã dự thảo"></dxo-label>
                                    <dxi-validation-rule type="required"></dxi-validation-rule>
                                </dxi-item>
                                <dxi-item [colSpan]="1" editorType="dxCheckBox" alignment="right" [editorOptions]="maDuThaoChkBoxOptions" [cssClass]="'autoChkBxClass'">
                                </dxi-item>
                            </dxi-item> -->

                            <dxi-item dataField="publishDate" [colSpan]="3" editorType="dxDateBox"
                                [editorOptions]="{ displayFormat:'dd/MM/yyyy', showClearButton: true, value: currentDate}">
                                <dxo-label text="Ngày soạn"></dxo-label>
                                <dxi-validation-rule type="required"></dxi-validation-rule>
                                <!-- <dx-date-box  displayFormat="dd/MM/yyyy" type="date"></dx-date-box> -->
                            </dxi-item>

                            <dxi-item [colSpan]="3" dataField="documentTypeId" editorType="dxSelectBox" [editorOptions]="{
                                dataSource: documentTypeOptions,
                                valueExpr: 'id',
                                displayExpr: 'typeName',
                                searchEnabled: true,
                                searchExpr: ['typeName', 'signal'],
                                showClearButton: true
                                }">
                                <dxo-label text="Loại VB"></dxo-label>
                                <!-- onValueChanged: docTypeSelectionChange -->
                                <!-- <dxi-validation-rule type="required"></dxi-validation-rule> -->
                            </dxi-item>

                            <dxi-item dataField="orgEditor" [colSpan]="3" editorType="dxSelectBox" [editorOptions]="{
                                dataSource: data_department,
                                valueExpr: 'id',
                                displayExpr: 'displayName',
                                disabled: true
                            }">
                                <dxo-label text="Phòng ban soạn"></dxo-label>
                            </dxi-item>
                            <dxi-item [colSpan]="3" dataField="secretLevel" editorType="dxSelectBox" [editorOptions]="{
                                dataSource: data_secretLevel,
                                valueExpr: 'key',
                                displayExpr: 'value',
                                searchEnabled: true,
                                searchExpr: 'value',
                                showClearButton: true
                                }">
                                <dxo-label text="Độ mật"></dxo-label>
                                <dxi-validation-rule type="required" message="Chưa chọn độ mật"></dxi-validation-rule>
                            </dxi-item>
                            <!-- <dxi-item [colSpan]="3" dataField="range" editorType="dxSelectBox" [editorOptions]="{
                                dataSource: data_range,
                                valueExpr: 'key',
                                displayExpr: 'value',
                                searchEnabled: true,
                                searchExpr: 'value',
                                showClearButton: true
                                }">
                                <dxo-label text="Lĩnh vực"></dxo-label>
                            </dxi-item>

                            <dxi-item [colSpan]="3" dataField="priority" editorType="dxSelectBox" [editorOptions]="{
                                dataSource: data_priority,
                                valueExpr: 'key',
                                displayExpr: 'value',
                                searchEnabled: true,
                                searchExpr: 'value',
                                showClearButton: true
                            }">
                                <dxo-label text="Độ khẩn"></dxo-label>
                            </dxi-item> -->


                            <dxi-item [colSpan]="6" dataField="isNoneSubmit" editorType="dxCheckBox" [editorOptions]="{

                            }">
                                <dxo-label text="Chưa nộp lưu"></dxo-label>
                            </dxi-item>

                            <dxi-item [colSpan]="3">
                                <dxo-label text="Số lượng VBPH"></dxo-label>
                                <dx-number-box dataField="quantityDocumentPublish" [(value)]="quantityDocPublishVal">
                                </dx-number-box>
                            </dxi-item>
                            <dxi-item [colSpan]="3">
                                <dxo-label text="Số tờ"></dxo-label>
                                <dx-number-box dataField="piecesOfPaper" [(value)]="piecesOfPaperVal"></dx-number-box>
                            </dxi-item>

                            <dxi-item itemType="group" colCount="24" [colSpan]="6">
                                <dxi-item [colSpan]="11">
                                    <dx-tag-box #groupReceiverTagBox id="groupReceiverTagBox" valueExpr="Id"
                                        [(dataSource)]="groupReceiverSource" displayExpr="GroupName"
                                        [searchEnabled]="true" [searchExpr]="['GroupName']"
                                        [showSelectionControls]="true" [(value)]="groupReceiverVal"
                                        [showClearButton]="true" (onOpened)="onOpenedTagBox($event)">
                                    </dx-tag-box>
                                    <dxo-label text="Nhóm nhận"></dxo-label>
                                </dxi-item>
                                <dxi-item [colSpan]="1">
                                    <dx-button icon="plus" alignment="right" (onClick)="showGroupReceiver()"
                                        [elementAttr]="{class: 'btnAddPublisher'}"></dx-button>
                                </dxi-item>
                                <dxi-item itemType="empty" [colSpan]="12"></dxi-item>


                                <dxi-item [colSpan]="12">
                                    <dx-tag-box #orgLevelTagBox id="orgLevelTagBox" [dataSource]="orgLevelSource"
                                        valueExpr="id" displayExpr="name" [searchEnabled]="true" [searchExpr]="['name']"
                                        [(value)]="selectedOrgLevels" (onValueChanged)="orgLevelValueChanged($event)">
                                    </dx-tag-box>
                                    <dxo-label text="Cấp nhận"></dxo-label>
                                </dxi-item>
                                <dxi-item [colSpan]="11">
                                    <!-- [(dataSource)]="selectedReceivers" -->
                                    <!-- <dx-tag-box #publishOrgTagBox
                                        id="publishOrgTagBox"
                                        valueExpr="id"
                                        [(dataSource)]="publishOrgSource"
                                        displayExpr="name"
                                        [searchEnabled]="true"
                                        [searchExpr]="['name']"
                                        [(value)]="displayReceiverList"
                                        [showSelectionControls]="true"
                                        applyValueMode="useButtons"
                                        >
                                    </dx-tag-box> -->
                                    <dx-drop-down-box #publishOrgTagBox dataField="publisher" id="publisherSelect"
                                        [dataSource]="publishOrgSource" valueExpr="id" displayExpr="name"
                                        [(value)]="displayReceiverList">
                                        <div *dxTemplate="let data of 'content'">
                                            <dx-tree-view [dataSource]="publishOrgSource" dataStructure="tree"
                                                keyExpr="id" parentIdExpr="parentId" selectionMode="multiple"
                                                displayExpr="name" showCheckBoxesMode="normal" [selectByClick]="true"
                                                (onContentReady)="$event.component.selectItem(treeBoxValue)"
                                                (onItemSelectionChanged)="treeView_itemSelectionChanged($event)"
                                                [searchExpr]="['name']">
                                            </dx-tree-view>
                                        </div>
                                    </dx-drop-down-box>
                                    <dxo-label text="Nơi nhận"></dxo-label>
                                </dxi-item>
                                <dxi-item [colSpan]="1">
                                    <dx-button icon="plus" alignment="right" (onClick)="showPublisherPopup()"
                                        [elementAttr]="{class: 'btnAddPublisher'}"></dx-button>
                                </dxi-item>
                            </dxi-item>

                            <dxi-item itemType="group" [colSpan]="6" colCount="24">
                                <dxi-item dataField="" [colSpan]="23" editorType="dxTagBox" [editorOptions]="{
                                    searchEnabled: true,
                                    noDataText: '',
                                    valueExpr: 'id',
                                    displayExpr: 'number',
                                    dataSource: selectedResponseDocs,
                                    value: selectedLinkedDocuments
                                }">
                                    <dxo-label text="Trả lời VB"></dxo-label>

                                    <!-- <dxi-item dataField="" [colSpan]="23">
                                    <dx-tag-box #linkedDocTagBox [noDataText]="" valueExpr="id" displayExpr="incommingNumber" [acceptCustomValue]="true" searchMode="contains"
                                        [dataSource]="selectedResponseDocs" [(value)]="selectedLinkedDocuments" (onKeyUp)="linkedDocKeyUp($event)" [searchEnabled]="false" [searchTimeout]="500"
                                    >

                                    </dx-tag-box> -->
                                    <!-- <dxi-item dataField="" [colSpan]="23" [editorOptions]="{value: linkDocumentVal}"> -->

                                </dxi-item>
                                <dxi-item dataField="" [colSpan]="1">
                                    <dx-button icon="search" alignment="right" (onClick)="selectReplyDocument()"
                                        [elementAttr]="{class: 'btnAddPublisher'}"></dx-button>
                                </dxi-item>
                            </dxi-item>

                            <dxi-item dataField="summary" [colSpan]="6" editorType="dxTextArea"
                                [editorOptions]="{ autoResizeEnabled: true }">
                                <dxo-label text="Trích yếu"></dxo-label>
                                <!-- <dxi-validation-rule type="required" message="Chưa nhập trích yếu"></dxi-validation-rule> -->
                            </dxi-item>

                            <!-- <dxi-item [colSpan]="3">
                                <dxo-label text="Tập tin"></dxo-label>
                                <dx-file-uploader

                                    [multiple]="true"
                                    selectButtonText="Chọn file đính kèm"
                                    labelText="Thả tệp để upload"
                                    accept="*"
                                    icon="upload"
                                    [(value)]="value"
                                     uploadMode="useForm"
                                    (onValueChanged)="setFullNameFile($event)">
                                </dx-file-uploader>

                            </dxi-item> -->
                            <dxi-item itemType="group" [colSpan]="3" colCount="12">
                                <dxi-item [colSpan]="12">
                                    <dxo-label text="Tập tin"></dxo-label>
                                    <!-- <dxi-validation-rule type="required"></dxi-validation-rule> -->
                                    <dx-file-uploader [multiple]="true" selectButtonText="Chọn file đính kèm" accept="*"
                                        icon="upload" [(value)]="value" uploadMode="useForm"
                                        (onValueChanged)="setFullNameFile($event)">
                                    </dx-file-uploader>
                                </dxi-item>
                                <dxi-item itemType="group" [colSpan]="12" colCount="12">
                                    <dxi-item [colSpan]="6">
                                        <dxo-label text="Scan văn bản"></dxo-label>
                                        <dx-button [disabled]="saving" text="Scan" type="success" icon="search"
                                            (onClick)="scan()">
                                        </dx-button>
                                    </dxi-item>
                                    <dxi-item [colSpan]="6">
                                        <dx-radio-group [dataSource]="scanTypes" displayExpr="display" valueExpr="value"
                                            [(value)]="scanType" (onValueChanged)="onScanTypeChanged($event)">
                                        </dx-radio-group>
                                        <!-- <dx-check-box
                                            [(value)]="isDuplex"
                                            [width]="120"
                                            text="Scan 2 mặt">
                                        </dx-check-box> -->
                                    </dxi-item>
                                </dxi-item>


                            </dxi-item>
                            <dxi-item [colSpan]="3">
                                <dx-data-grid id="gridContainer" [dataSource]="selectedRows"
                                    [allowColumnReordering]="true" [allowColumnResizing]="true" [columnAutoWidth]="true"
                                    [showBorders]="true" [noDataText]="''">
                                    <dxo-paging [pageSize]="10"></dxo-paging>
                                    <dxo-pager [showPageSizeSelector]="true" [allowedPageSizes]="[5, 10, 20]"
                                        [showInfo]="true">
                                    </dxo-pager>
                                    <dxi-column dataField="tepDinhKem" caption="Tệp đính kèm"></dxi-column>
                                    <dxi-column caption="Xem chi tiết" cellTemplate="detailTemplate" [width]="100">
                                    </dxi-column>
                                    <dxi-item caption="Xóa" cellTemplate="deleteTemplate">
                                    </dxi-item>

                                    <div *dxTemplate="let d of 'detailTemplate'">
                                        <div class="row">
                                            <div class="col-6" style="text-align: center;" (click)="showDetail(d)">
                                                <span><i class="fab fa-buffer"></i></span>
                                            </div>
                                            <div class="col-6" style="text-align: center;" (click)="deleteFile(d)">
                                                <span><i class="fas fa-trash-alt"></i> </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div *dxTemplate="let d of 'deleteTemplate'">
                                        <div class="col-2" style="text-align: center;" (click)="deleteFile(d)">
                                            <span><i class="fas fa-trash-alt"></i> </span>
                                        </div>
                                    </div>
                                </dx-data-grid>
                            </dxi-item>
                            <!-- <dxi-item dataField="leaderType" itemType="group" [colSpan]="3" >
                                <dxo-label text="Người ký " ></dxo-label>
                                <dx-radio-group
                                    [dataSource]="leaderType"
                                    [(value)]="leaderTypeVal"
                                    displayExpr="name"
                                    valueExpr="id"
                                    (onValueChanged)="radio_nguoi_ky()"
                                    layout="horizontal">
                                </dx-radio-group>
                                <dxi-validation-rule type="required" message="Chưa chọn loại người ký"></dxi-validation-rule>
                            </dxi-item> -->
                            <dxi-item [colSpan]="3" dataField="leaderId">
                                <dxo-label text="Người ký"></dxo-label>
                            </dxi-item>
                            <dxi-item itemType="empty" [colSpan]="3"></dxi-item>

                            <dxi-item dataField="note" [colSpan]="6" editorType="dxTextArea"
                                [editorOptions]="{ autoResizeEnabled: true }">
                                <dxo-label text="Ghi chú"></dxo-label>
                            </dxi-item>
                        </dxi-item>
                        <!-- <dxi-item itemType="group" colCount="12" caption="Thông tin xử lý">
                            <dxi-item [label]="{text: 'Trình CH'}" [colSpan]="12" dataField="leaderDepartmentId"
                                editorType="dxSelectBox" [editorOptions]="{
                                dataSource: captain_department,
                                valueExpr: 'userId',
                                displayExpr: 'nameWithPosition',
                                searchEnabled: true,
                                searchExpr: 'fullName'
                                }">
                                <dxi-validation-rule type="required"></dxi-validation-rule>
                            </dxi-item>
                            <dxi-item dataField="processingRecommended" [colSpan]="12" editorType="dxTextArea" [editorOptions]="{
                                height: 90
                            }">
                            <dxo-label text="Ý kiến xử lý "></dxo-label>
                            </dxi-item>
                        </dxi-item> -->
                    </dx-form>

                    <dx-popup [width]="800" [height]="600" [showTitle]="true" title="Nơi nhận văn bản"
                        [dragEnabled]="false" [closeOnOutsideClick]="false" [(visible)]="receiverPopupVisible">

                        <div class="col-xl-12 col-md-12 col-xs-12" style="padding-bottom: 17px;padding-left:0;">
                            <dx-button text="Trở về" type="success" icon="fa fa-arrow-left" (onClick)="closePopUp()">
                            </dx-button>
                            &nbsp;
                            <dx-button [disabled]="saving" text="Chọn" type="success" icon="save"
                                (onClick)="saveReceiveList()"> </dx-button>
                            &nbsp;
                            <dx-button [disabled]="saving" text="Xóa" type="success" icon="fa fa-trash"></dx-button>
                        </div>
                        <div class="col-xl-12 col-md-12 col-xs-12">
                            <!-- <dx-form #documentForm [showValidationSummary]="true"
                            [showColonAfterLabel]="false" validationGroup="formValidateGroup">
                            <dxi-item itemType="group" colCount="20">
                                <dxi-item [colSpan]="19" editorType="dxTextBox">
                                    <dxo-label text="Tìm kiếm gợi nhớ"></dxo-label>
                                </dxi-item>
                                <dxi-item [colSpan]="1">
                                    <dx-button icon="plus" alignment="right" [elementAttr]="{class: 'btnAddPublisher'}"></dx-button>
                                </dxi-item>
                                <dxi-item [colSpan]="20" editorType="dxTextBox">
                                    <dxo-label text="Tên gợi nhớ"></dxo-label>
                                </dxi-item>
                                <dxi-item itemType="empty" [colSpan]="16"></dxi-item>
                                <dxi-item [colSpan]="4">
                                    <dx-check-box text="Lưu gợi nhớ"></dx-check-box>
                                </dxi-item>
                            </dxi-item>


                        </dx-form> -->
                            <div class="row">
                                <div class="col-md-6 col-xs-12">
                                    <fieldset style="border: 1px solid; padding: 10px">
                                        <legend style="font-weight: bold; width: 180px;">Danh sách đơn vị</legend>
                                        <dx-tree-view #treeView [width]="300" [height]="300" displayExpr="name"
                                            valueExpr="id" [searchEnabled]="true" [searchExpr]="['name']"
                                            showCheckBoxesMode="selectAll" [selectionMode]="'multiple'"
                                            [selectNodesRecursive]="true" [selectByClick]="true"
                                            (onSelectionChanged)="onSelectionChanged($event)">
                                        </dx-tree-view>

                                    </fieldset>
                                </div>
                                <div class="col-md-6 col-xs-12">
                                    <fieldset style="padding: 10px">
                                        <legend style="font-weight: bold; width: 100px;">Đã chọn</legend>
                                        <dx-tree-view #treeViewDisplay [(dataSource)]="selectedReceivers" [width]="300"
                                            [height]="300" displayExpr="text" valueExpr="key">

                                        </dx-tree-view>
                                    </fieldset>
                                </div>
                            </div>
                        </div>
                    </dx-popup>
                    <dx-load-panel #loadPanel shadingColor="rgba(220,220,220, 0.5)"
                        [position]="{ my: 'center', at: 'center', of: 'window' }" [(visible)]="saving"
                        [showIndicator]="true" message="Đang xử lý..." [showPane]="true" [shading]="true"
                        [closeOnOutsideClick]="false">
                    </dx-load-panel>
                </div>
            </div>
        </div>
    </div>

    <createReceiver #createReceiver (saveSuccess)="getPublishOrg()"></createReceiver>
    <groupReceiver #groupReceiver (saveSuccessGroup)="getGroupReceiver()" [typeGroupChild]="typeGroup"></groupReceiver>
    <searchResponseDocumentModal #searchResponseDocumentModal (modalSave)="getResponseDocuments($event)">
    </searchResponseDocumentModal>
    <style>
        .spiner_global {
            display: none !important;
        }
    </style>
</div>